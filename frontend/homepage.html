<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <title>Streamio</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
  </head>

  <body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <!--Navbar-->
    <nav class="navbar fixed-top bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="homepage.html"><img src="logo.svg" width="90"></a>
        <form class="d-flex" role="search">
            <input class="form-control me-2 search-input" type="search" placeholder="Search" aria-label="Search"/>
            <button class="btn custom-button" type="submit">Search</button>
        </form>
        <button class="btn custom-button"><a href="login.html">Login/Signup</a></button>
    </div>
    </nav>



    <main class="content-area">


        <!--Options-->
        <div class="options-filter-container">
            <div class="options-bar">
                <a href="#" class="option-item active" data-category="all">Live</a>
                <a href="#" class="option-item" data-category="clubs">Clubs</a>
                <a href="#" class="option-item" data-category="school">School</a>
                <a href="#" class="option-item" data-category="people">People</a>
                <a href="#" class="option-item" data-category="events">Events</a>
            </div>
            <!--Create Club button and Upcoming Events title in line with the filter button-->
            <button class="btn btn-primary custom-button" id="createClubBtn" style="display: none; position: absolute; left: 50%; transform: translateX(-50%);" data-bs-toggle="modal" data-bs-target="#createClubModal">
                Create Club
            </button>
            
            <h1 id="eventsTitle" style="display: none; position: absolute; left: 50%; transform: translateX(-50%); margin: 0; font-size: 1.5rem;">Upcoming Events</h1>
            
            <button class="filter-button" id="filterButton">
                <span class="icon">&#9776;</span> Filter
            </button>
        </div>

        <!--Filter-->
       <div class="filter-options-dropdown" id="filterOptions">
    
            <div class="dropdown filter-chip-dropdown">

                 <button class="btn btn-secondary dropdown-toggle filter-chip" data-filter="category" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Category <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Events</a></li>
                    <li><a class="dropdown-item" href="#">Sports</a></li>
                    <li><a class="dropdown-item" href="#">Academics</a></li>
                    <li><a class="dropdown-item" href="#">Gaming</a></li>
                </ul>

                 <button class="btn btn-secondary dropdown-toggle filter-chip" data-filter="school" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    School <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">UTRGV</a></li>
                    <li><a class="dropdown-item" href="#">CSCI</a></li>
                    <li><a class="dropdown-item" href="#">CMPE</a></li>
                    <li><a class="dropdown-item" href="#">BSN</a></li>
                </ul>

                <button class="btn btn-secondary dropdown-toggle filter-chip" data-filter="location" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Location <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Edinburg</a></li>
                    <li><a class="dropdown-item" href="#">Brownsville</a></li>
                </ul>
            </div>

            <button class="btn btn-primary mt-3 save-changes-btn">Save Changes</button>
        </div>

        <!--Video Placeholders-->
        <div class="video-results" id="videoResults">
          
            <div class="video-placeholder" data-category="all" data-vid-category="Academics" data-vid-school="CSCI" data-vid-location="Edinburg">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Hackathon</div>
                        <span class="video-filter-tag">CSCI</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="live" data-vid-school="UTRGV">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Football Game</div>
                        <span class="video-filter-tag">UTRGV</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="school" data-vid-school="Brownsville">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">CSCI 3333 Final Review</div>
                        <span class="video-filter-tag">CSCI</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="clubs" data-vid-category="Gaming">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Game Dev Club Meeting</div>
                        <span class="video-filter-tag">GAMEDEV</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="people" data-vid-category="Academics">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Resume Review</div>
                        <span class="video-filter-tag">Frontera Devs</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="live" data-vid-category="Events">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Guest Speaker</div>
                        <span class="video-filter-tag">UTRGV</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="school">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">UTRGV Major Showcase</div>
                        <span class="video-filter-tag">UTRGV</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="clubs" data-vid-category="Sports" data-vid-location="Brownsville">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Basketball Runs</div>
                        <span class="video-filter-tag">UREC</span>
                    </div>
                </div>
            </div>

            <div class="video-placeholder" data-category="people" data-vid-location="Edinburg">
                <div class="thumbnail-block"></div>
                <div class="video-info">
                    <div class="profile-pic"></div>
                    <div>
                        <div class="title-block">Code Review</div>
                        <span class="video-filter-tag">John Doe</span>
                    </div>
                </div>
            </div>
        </div>

        <!--Events-->
        <div class="events-page" id="eventsPage" style="display: none;">
            <div class="container mt-4">
                
                <div class="d-flex justify-content-center mb-4">
                    <button 
                        id="createEventBtn"
                        class="btn btn-primary custom-button" 
                        data-bs-toggle="modal" 
                        data-bs-target="#createEventModal"
                    >
                        Create Event
                    </button>
                </div>

                <div id="events-list" class="events-grid">
                    <div class="card event-card shadow-sm">
                        <div class="card-body">
                            <h5 class="event-card-title">Poster Presentation</h5>
                            <h6 class="event-card-subtitle">October 29, 2025 at 5:00 PM</h6>
                            <p class="event-card-location">Edinburg Campus, EIEAB Building</p>
                            <p class="event-card-description">Join us to view projects our seniors are doing.</p>
                        </div>
                    </div>

                    <div class="card event-card shadow-sm">
                        <div class="card-body">
                            <h5 class="event-card-title">UTRGV Graduation Ceremony</h5>
                            <h6 class="event-card-subtitle">December 20, 2025 at 10:00 AM</h6>
                            <p class="event-card-location">Edinburg, Bert Ogden Arena</p>
                            <p class="event-card-description">Come join us in supporting our UTRGV Graduates.</p>
                        </div>
                    </div>

                    <div class="card event-card shadow-sm">
                        <div class="card-body">
                            <h5 class="event-card-title">Tech Workshop Series</h5>
                            <h6 class="event-card-subtitle">November 15, 2025 at 2:00 PM</h6>
                            <p class="event-card-location">Computer Science Building, Room 101</p>
                            <p class="event-card-description">Join us for an intensive workshop covering modern web development technologies including React, Node.js, and cloud deployment. This hands-on session will guide you through building a full-stack application from scratch. Perfect for beginners and intermediate developers looking to expand their skillset. Bring your laptop and be ready to code! Refreshments will be provided. Limited seats available, so register early to secure your spot.</p>
                        </div>
                    </div>

                    <div class="card event-card shadow-sm">
                        <div class="card-body">
                            <h5 class="event-card-title">Career Fair 2025</h5>
                            <h6 class="event-card-subtitle">January 10, 2026 at 9:00 AM</h6>
                            <p class="event-card-location">University Center Ballroom</p>
                            <p class="event-card-description">Network with top employers and explore career opportunities.</p>
                        </div>
                    </div>

                </div>
                
            </div>
            
            <!--Create Event Form-->
            <div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #353434; color:white;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body">
                            <form id="event-creation-form">
                                
                                <div class="mb-3">
                                    <label for="eventName" class="form-label">Event Name</label>
                                    <input type="text" class="form-control" id="eventName" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="eventTime" class="form-label">Date and Time</label>
                                    <input type="datetime-local" class="form-control" id="eventTime" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="eventLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="eventLocation" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="eventDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
                                </div>

                            </form>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success custom-button" form="event-creation-form">Create Event</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Create Club Form-->
        <div class="modal fade" id="createClubModal" tabindex="-1" aria-labelledby="createClubModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" style="background-color: #353434; color:white;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createClubModalLabel">Create New Club</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="modal-body">
                        <form id="club-creation-form">
                            
                            <div class="mb-3">
                                <label for="clubName" class="form-label">Club Name</label>
                                <input type="text" class="form-control" id="clubName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="clubCategory" class="form-label">Category</label>
                                <select class="form-select" id="clubCategory" required>
                                    <option value="">Select a category</option>
                                    <option value="sports">Sports</option>
                                    <option value="academics">Academics</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="arts">Arts</option>
                                    <option value="technology">Technology</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="clubDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="clubDescription" rows="3" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="clubContact" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="clubContact" required>
                            </div>

                        </form>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success custom-button" form="club-creation-form">Create Club</button>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get the references
            const options = document.querySelectorAll('.option-item');
            const videos = document.querySelectorAll('.video-placeholder');
            const videoResults = document.getElementById('videoResults');
            const eventsPage = document.getElementById('eventsPage');
            const createClubBtn = document.getElementById('createClubBtn');
            const createEventBtn = document.getElementById('createEventBtn');
            const eventsTitle = document.getElementById('eventsTitle');
            const isLoggedIn = !!localStorage.getItem('user');
            const filterButton = document.getElementById('filterButton');
            const filterOptions = document.getElementById('filterOptions');
            const saveChangesBtn = document.querySelector('.save-changes-btn');

            // --- Filter State ---
            const activeDropdownFilters = {
                category: null,
                school: null,
                location: null
            };

            function filterVideos(mainCategory, dropdownFilters) {
                videos.forEach(video => {
                    const videoMainCategory = video.getAttribute('data-category');
                    const videoCat = video.getAttribute('data-vid-category');
                    const videoSchool = video.getAttribute('data-vid-school');
                    const videoLocation = video.getAttribute('data-vid-location');

                    const matchesMain = (mainCategory === 'all' || videoMainCategory === mainCategory);
                    const matchesCat = !dropdownFilters.category || (videoCat === dropdownFilters.category);
                    const matchesSchool = !dropdownFilters.school || (videoSchool === dropdownFilters.school);
                    const matchesLocation = !dropdownFilters.location || (videoLocation === dropdownFilters.location);

                    video.style.display = (matchesMain && matchesCat && matchesSchool && matchesLocation) ? 'flex' : 'none';
                });
            }

            // ADD: Click event for video placeholders to go to live page
            videos.forEach(video => {
                video.addEventListener('click', () => {
                    window.location.href = 'live.html';
                });
                
                // Add cursor pointer style
                video.style.cursor = 'pointer';
            });

            // Shows the videos of the selected category OR shows events page
            function filterContent(category) {
                const mainCategory = category || 'all';

                if (category === 'events') {
                    // Hide videos, show events
                    videoResults.style.display = 'none';
                    eventsPage.style.display = 'block';
                    if (createClubBtn) createClubBtn.style.display = 'none';
                    if (createEventBtn) createEventBtn.style.display = isLoggedIn ? 'block' : 'none';
                    eventsTitle.style.display = 'block';
                    filterButton.style.display = 'block';
                    filterOptions.classList.remove('active');
                } else if (category === 'clubs') {
                    // Show videos, hide events, show create club button
                    videoResults.style.display = 'grid';
                    eventsPage.style.display = 'none';
                    if (createClubBtn) createClubBtn.style.display = isLoggedIn ? 'block' : 'none';
                    eventsTitle.style.display = 'none';
                    filterButton.style.display = 'none';
                    filterOptions.classList.remove('active');
                    
                    // Filter videos by category
                    videos.forEach(video => {
                        const videoCategory = video.getAttribute('data-category');
                        video.style.display = (videoCategory === 'clubs') ? 'flex' : 'none';
                    });
                } else if (category === 'all') {
                    // Show videos, hide events and create club button, show filter
                    videoResults.style.display = 'grid';
                    eventsPage.style.display = 'none';
                    if (createClubBtn) createClubBtn.style.display = 'none';
                    if (createEventBtn) createEventBtn.style.display = 'none';
                    eventsTitle.style.display = 'none';
                    filterButton.style.display = 'block';
                    
                    // Show all videos
                    videos.forEach(video => {
                        video.style.display = 'flex';
                    });
                } else {
                    // Show videos, hide events and create club button, hide filter
                    videoResults.style.display = 'grid';
                    eventsPage.style.display = 'none';
                    if (createClubBtn) createClubBtn.style.display = 'none';
                    if (createEventBtn) createEventBtn.style.display = 'none';
                    eventsTitle.style.display = 'none';
                    filterButton.style.display = 'none';
                    filterOptions.classList.remove('active');
                    
                    // Filter videos by category
                    videos.forEach(video => {
                        const videoCategory = video.getAttribute('data-category');
                        video.style.display = (videoCategory === category) ? 'flex' : 'none';
                    });
                }
                // Apply filters
                filterVideos(mainCategory, activeDropdownFilters);
            }
            
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault(); 

                    // Gets the category selected
                    const selectedCategory = e.target.getAttribute('data-category');     

                    options.forEach(item => item.classList.remove('active'));
                    e.target.classList.add('active'); 

                    // Filter content depending on category selected
                    filterContent(selectedCategory);
                });
            });

            // --- Dropdown Filter Selection ---
            document.querySelectorAll('.filter-options-dropdown .dropdown-toggle').forEach(button => {
                const filterType = button.dataset.filter; // category / school / location
                const menu = button.nextElementSibling;

                if (!menu) return;

                menu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const selectedValue = item.textContent.trim();

                        // Update button label
                        button.innerHTML = `${filterType.charAt(0).toUpperCase() + filterType.slice(1)}: ${selectedValue} <span class="caret"></span>`;

                        // Update state
                        activeDropdownFilters[filterType] =
                            selectedValue.toLowerCase().includes('all') ? null : selectedValue;
                    });
                });
            });

            // --- Save Changes ---
            saveChangesBtn.addEventListener('click', () => {
                const activeTab = document.querySelector('.option-item.active');
                const mainCategory = activeTab ? activeTab.getAttribute('data-category') : 'all';
                filterVideos(mainCategory, activeDropdownFilters);
                filterOptions.classList.remove('active');
            });

            // initial visibility based on auth
            if (createClubBtn) createClubBtn.style.display = isLoggedIn ? 'block' : 'none';
            if (createEventBtn) createEventBtn.style.display = isLoggedIn ? 'block' : 'none';
            eventsTitle.style.display = 'none';
            const initialCategory = document.querySelector('.option-item.active').getAttribute('data-category');
            filterContent(initialCategory); 

            // Filter button dropdown filter menu
            filterButton.addEventListener('click', () => {
                filterOptions.classList.toggle('active');
            });
            
        });
    </script>
        <!-- Supabase client (CDN) -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

        <!-- Events / Supabase logic -->
        <script>
            (function() {
                // Backend API URL (change if your backend runs elsewhere)
                const API_URL = localStorage.getItem('API_URL') || 'http://localhost:4000';

                // Read Supabase config from localStorage if you still want direct realtime client usage
                const SUPABASE_URL = localStorage.getItem('SUPABASE_URL') || 'YOUR_SUPABASE_URL';
                const SUPABASE_ANON_KEY = localStorage.getItem('SUPABASE_ANON_KEY') || 'YOUR_SUPABASE_ANON_KEY';

                const dbNotConfigured = (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY');

                if (dbNotConfigured) {
                    console.warn('Supabase URL / ANON KEY not set. To enable events DB integration, store SUPABASE_URL and SUPABASE_ANON_KEY in localStorage or replace the placeholders in the script.');
                }

                // Robust client creation: support different UMD globals and ESM helpers
                let supabase = null;
                try {
                    if (typeof createClient === 'function') {
                        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('Supabase client created via createClient()');
                    } else if (typeof supabaseJs !== 'undefined' && typeof supabaseJs.createClient === 'function') {
                        supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('Supabase client created via supabaseJs.createClient()');
                    } else if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                        // some UMDs expose a `supabase` global with createClient
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('Supabase client created via window.supabase.createClient()');
                    } else if (!dbNotConfigured) {
                        console.warn('Supabase client factory not found on window. Check the loaded supabase script version.');
                    }
                } catch (e) {
                    console.error('Error creating Supabase client:', e);
                }

                // Helpers
                function formatDate(iso) {
                    try {
                        const d = new Date(iso);
                        return d.toLocaleString();
                    } catch (e) { return iso; }
                }

                function renderEventCard(ev) {
                    // ev: { event_name, time, description }
                    const list = document.getElementById('events-list');
                    if (!list) return;

                    // If the event has an id and we already rendered it, skip to avoid duplicates
                    const idKey = ev.event_id || ev.id || ev.eventId || ev.eventID;
                    if (idKey) {
                        const existing = list.querySelector(`[data-event-id="${idKey}"]`);
                        if (existing) {
                            console.debug('Skipping render â€” event already present:', idKey);
                            return;
                        }
                    }

                    const card = document.createElement('div');
                    card.className = 'card event-card shadow-sm';
                    const body = document.createElement('div');
                    body.className = 'card-body';

                    const title = document.createElement('h5');
                    title.className = 'event-card-title';
                    title.textContent = ev.event_name || 'Untitled Event';

                    const subtitle = document.createElement('h6');
                    subtitle.className = 'event-card-subtitle';
                    subtitle.textContent = ev.time ? formatDate(ev.time) : '';

                    // Try to detect a location saved as the first line of description
                    let locationText = '';
                    let descriptionText = ev.description || '';
                    if (descriptionText) {
                        const parts = descriptionText.split('\n');
                        if (parts.length > 1 && parts[0].trim().length < 200 && parts[0].length < 200) {
                            locationText = parts[0].trim();
                            descriptionText = parts.slice(1).join('\n').trim();
                        }
                    }

                    const loc = document.createElement('p');
                    loc.className = 'event-card-location';
                    loc.textContent = locationText;

                    const desc = document.createElement('p');
                    desc.className = 'event-card-description';
                    desc.textContent = descriptionText;

                    body.appendChild(title);
                    body.appendChild(subtitle);
                    if (locationText) body.appendChild(loc);
                    if (descriptionText) body.appendChild(desc);
                    card.appendChild(body);

                    // Attach id attribute for deduping if present
                    if (idKey) card.setAttribute('data-event-id', idKey);

                    // Prepend newest events
                    list.insertBefore(card, list.firstChild);
                }

                async function fetchEvents() {
                    try {
                        const res = await fetch(API_URL + '/events');
                        if (!res.ok) throw new Error('Failed to fetch events: ' + res.statusText);
                        const data = await res.json();

                        // Clear existing dynamic cards
                        const list = document.getElementById('events-list');
                        if (!list) return;
                        list.innerHTML = '';

                        data.forEach(ev => renderEventCard(ev));
                    } catch (err) {
                        console.error('Error fetching events from backend:', err.message || err);
                    }
                }

                async function createEvent(eventPayload) {
                    try {
                        const res = await fetch(API_URL + '/events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventPayload)
                        });

                        if (!res.ok) {
                            const text = await res.text().catch(() => res.statusText);
                            throw new Error('API error: ' + text);
                        }

                        const created = await res.json();
                        return created;
                    } catch (err) {
                        console.error('Error creating event via backend:', err.message || err);
                        // fallback: render locally so user sees result
                        const localEv = Object.assign({}, eventPayload);
                        renderEventCard(localEv);
                        return localEv;
                    }
                }

                // Realtime subscription with fallback checks (v2 vs v1)
                function subscribeToInserts() {
                    if (!supabase) {
                        console.warn('Supabase client not available - realtime subscription disabled.');
                        return null;
                    }
                    try {
                        if (typeof supabase.channel === 'function') {
                            // supabase-js v2 realtime
                            const channel = supabase.channel('public:events')
                                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'events' }, (payload) => {
                                    if (payload && payload.new) renderEventCard(payload.new);
                                })
                                .subscribe();
                            return channel;
                        } else if (typeof supabase.from === 'function') {
                            // older API fallback
                            const sub = supabase.from('events').on('INSERT', payload => {
                                if (payload && payload.new) renderEventCard(payload.new);
                            }).subscribe();
                            return sub;
                        }
                    } catch (e) {
                        console.warn('Realtime subscription failed (this is optional):', e.message || e);
                    }
                }

                // Wire up form
                document.addEventListener('DOMContentLoaded', () => {
                    const form = document.getElementById('event-creation-form');
                    if (!form) return;

                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('eventName').value.trim();
                        const time = document.getElementById('eventTime').value;
                        const location = document.getElementById('eventLocation').value.trim();
                        const description = document.getElementById('eventDescription').value.trim();

                        // Get user id from localStorage (depends on your auth payload)
                        let userId = null;
                        try {
                            const raw = localStorage.getItem('user');
                            if (raw) {
                                const u = JSON.parse(raw);
                                userId = u?.id || u?.user_id || u?.userId || null;
                            }
                        } catch (err) { /* ignore */ }

                        const payload = {
                            user_id: userId,
                            event_name: name,
                            club_id: null,
                            school_id: null,
                            time: time || null,
                            event_logo: null,
                            description: (location ? location + '\n\n' : '') + (description || '')
                        };

                        try {
                            const created = await createEvent(payload);
                                // Hide modal
                            const modalEl = document.getElementById('createEventModal');
                            try {
                                const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                bsModal.hide();
                            } catch (err) {
                                // ignore
                            }

                            // Render created event only if it hasn't already been rendered
                            if (created) {
                                const createdId = created.event_id || created.id || created.eventId || created.eventID;
                                const list = document.getElementById('events-list');
                                const already = createdId && list ? list.querySelector(`[data-event-id="${createdId}"]`) : null;
                                if (!already) renderEventCard(created);
                            }

                            // Reset form
                            form.reset();
                        } catch (err) {
                            alert('Failed to create event. See console for details.');
                        }
                    });

                    // Initial load
                    fetchEvents();
                    subscribeToInserts();
                });
            })();
        </script>

        <!-- auth script: renders avatar if logged in -->
        <script src="./auth.js"></script>
  </body>     
</html>